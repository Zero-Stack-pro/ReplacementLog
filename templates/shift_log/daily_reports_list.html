{% extends 'base.html' %}

{% block title %}Ежедневные отчёты{% endblock %}

{% block extra_css %}
<style>
.table-responsive {
    overflow-x: hidden !important;
    overflow-y: visible;
}
.table-responsive::-webkit-scrollbar {
    display: none !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4"><i class="bi bi-journal-text"></i> Ежедневные отчёты</h2>
    <form method="get" class="row g-3 mb-4 align-items-end">
        <div class="col-auto">
            <label for="date_from" class="form-label">С даты</label>
            <input type="date" id="date_from" name="date_from" class="form-control" value="{{ date_from }}">
        </div>
        <div class="col-auto">
            <label for="date_to" class="form-label">По дату</label>
            <input type="date" id="date_to" name="date_to" class="form-control" value="{{ date_to }}">
        </div>
        {% if departments %}
        <div class="col-auto">
            <label for="department" class="form-label">Отдел</label>
            <select id="department" name="department" class="form-select">
                <option value="">Все отделы</option>
                {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if dept.id|stringformat:'s' == selected_department %}selected{% endif %}>{{ dept.name }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <div class="col-auto">
            <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Показать</button>
        </div>
    </form>
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Дата</th>
                    <th>Отдел</th>
                    <th>Комментарий</th>
                    <th>Фотографии</th>
                    <th>Автор</th>
                    <th>Обновлено</th>
                </tr>
            </thead>
            <tbody>
                {% for report in reports %}
                <tr>
                    <td>{{ report.date|date:'d.m.Y' }}</td>
                    <td>{{ report.department.name }}</td>
                    <td style="white-space: pre-line; max-width: 300px;">{{ report.comment|default:'—' }}</td>
                    <td>
                        {% if report.photos.all %}
                            <div class="d-flex flex-wrap gap-1">
                                {% for photo in report.photos.all|slice:":3" %}
                                    <img src="{{ photo.image.url }}" 
                                         alt="Фото отчета" 
                                         class="img-thumbnail" 
                                         style="width: 50px; height: 50px; object-fit: cover;"
                                         data-bs-toggle="modal" 
                                         data-bs-target="#photoModal{{ photo.id }}">
                                {% endfor %}
                                {% if report.photos.count > 3 %}
                                    <span class="badge bg-secondary">+{{ report.photos.count|add:"-3" }}</span>
                                {% endif %}
                            </div>
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>{% if report.created_by %}{{ report.created_by.get_full_name|default:report.created_by.username }}{% else %}—{% endif %}</td>
                    <td>{{ report.updated_at|date:'d.m.Y H:i' }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted">Нет отчётов за выбранный период</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Модальные окна для просмотра фотографий -->
{% for report in reports %}
    {% for photo in report.photos.all %}
    <div class="modal fade" id="photoModal{{ photo.id }}" tabindex="-1" aria-labelledby="photoModalLabel{{ photo.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="photoModalLabel{{ photo.id }}">
                        Фото отчета {{ report.department.name }} - {{ report.date|date:'d.m.Y' }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="{{ photo.image.url }}" class="img-fluid" alt="Фото отчета">
                    {% if photo.caption %}
                        <div class="mt-3">
                            <p class="text-muted">{{ photo.caption }}</p>
                        </div>
                    {% endif %}
                    <div class="mt-2">
                        <small class="text-muted">
                            Загружено: {{ photo.uploaded_at|date:'d.m.Y H:i' }} 
                            пользователем {{ photo.uploaded_by.get_full_name }}
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endfor %}
{% endblock %} 