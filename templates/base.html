<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}Система сменного журнала{% endblock %}</title>
    
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    {% load static %}
    <!-- Custom CSS -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    
    {% block extra_css %}{% endblock %}
    <style>
    html, body { height: 100%; }
    /* Светлый navbar и гармония с sidebar */
    .navbar {
        background: #f8f9fa !important;
        box-shadow: none !important;
        border-bottom: 1.5px solid #e3e6ea;
        color: #222;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1040;
        height: 56px;
        min-height: 56px;
    }
    .navbar .navbar-brand, .navbar .nav-link, .navbar .navbar-text {
        color: #1976d2 !important;
        font-weight: 600;
        letter-spacing: 0.01em;
    }
    .navbar .nav-link:hover, .navbar .nav-link:focus {
        color: #1565c0 !important;
        background: #e9ecef;
        border-radius: 8px;
    }
    #sidebarMenu {
        left: 0;
        transition: left 0.3s, box-shadow 0.3s;
        background: #f8f9fa;
        box-shadow: 2px 0 16px 0 rgba(60,60,90,0.08), 0 1.5px 0 0 #e9ecef;
        border-radius: 0 0 18px 0;
        min-height: 100vh;
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
        width: 230px;
        position: fixed;
        top: 56px;
        z-index: 1030;
    }
    #sidebarMenu .nav-link {
        color: #495057;
        font-size: 1.08rem;
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        margin: 0.15rem 0.5rem;
        display: flex;
        align-items: center;
        transition: background 0.18s, color 0.18s;
    }
    #sidebarMenu .nav-link i {
        font-size: 1.25em;
        margin-right: 0.7em;
        opacity: 0.85;
    }
    #sidebarMenu .nav-link.active, #sidebarMenu .nav-link:focus {
        background: linear-gradient(90deg, #e3f0ff 0%, #f8f9fa 100%);
        color: #1976d2;
        font-weight: 600;
        box-shadow: 0 2px 8px 0 rgba(25,118,210,0.07);
    }
    #sidebarMenu .nav-link:hover {
        background: #e9ecef;
        color: #1565c0;
    }
    #sidebarMenu hr {
        border-top: 1.5px solid #e3e6ea;
        margin: 1.2rem 0;
    }
    #sidebarMenu .sidebar-header {
        font-size: 1.15rem;
        font-weight: 700;
        color: #1976d2;
        margin-bottom: 1.2rem;
        padding-left: 1.25rem;
        letter-spacing: 0.02em;
    }
    .sidebar-backdrop { display: none; }
    #mainContent {
        transition: margin-left 0.3s;
        padding-top: 56px;
    }
    body.sidebar-collapsed #sidebarMenu { left: -230px !important; box-shadow: none; }
    body.sidebar-collapsed #mainContent { margin-left: 0 !important; }
    @media (max-width: 991px) {
        #sidebarMenu {
            left: -230px !important;
            border-radius: 0 18px 18px 0;
            box-shadow: 2px 0 16px 0 rgba(60,60,90,0.08);
        }
        #sidebarMenu.show {
            left: 0 !important;
        }
        .sidebar-backdrop {
            display: block;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.13);
            z-index: 1039;
        }
        #mainContent { margin-left: 0 !important; }
        body.sidebar-collapsed #sidebarMenu { left: -230px !important; }
    }
    @media (min-width: 992px) {
        #sidebarMenu { left: 0 !important; }
        .sidebar-backdrop { display: none !important; }
    }
    .navbar .user-avatar i {
        color: #2563eb;
    }
    body.sidebar-collapsed #sidebarMenu {
        left: -230px !important;
    }
    body.sidebar-collapsed #mainContent {
        margin-left: 0 !important;
    }
    @media (min-width: 768px) {
        #sidebarMenu {
            left: 0;
        }
        body.sidebar-collapsed #sidebarMenu {
            left: -230px !important;
        }
        body.sidebar-collapsed #mainContent {
            margin-left: 0 !important;
        }
    }
    </style>
</head>
<body>
    <!-- Sidebar + Topbar Layout -->
    <div class="d-flex">
        <!-- Sidebar -->
        {% if user.is_authenticated %}
        <nav id="sidebarMenu" class="d-md-block sidebar collapse position-fixed h-100" style="width: 230px; z-index: 1030; left: 0; transition: left 0.3s;">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item mb-2">
                        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'shift_log:dashboard' %}">
                            <i class="bi bi-house"></i> <span>Главная</span>
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'shift_log:project_list' %}">
                            <i class="bi bi-kanban"></i> <span>Мои проекты</span>
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'testing:feature_list' %}">
                            <i class="bi bi-bug"></i> <span>Тестирование</span>
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'shift_log:material_writeoff_list' %}">
                            <i class="bi bi-box-arrow-down"></i> <span>Все списания</span>
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'shift_log:daily_reports_list' %}">
                            <i class="bi bi-journal-text"></i> <span>Ежедневные отчёты</span>
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'shift_log:reports_list' %}">
                            <i class="bi bi-clock-history"></i> <span>История заданий</span>
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link d-flex align-items-center gap-2" href="{% url 'shift_log:note_list' %}">
                            <i class="bi bi-sticky"></i> <span>Заметки</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        {% endif %}
        <!-- Optional: Sidebar backdrop for mobile -->
        <div class="sidebar-backdrop d-none" id="sidebarBackdrop" tabindex="-1"></div>
        <!-- Topbar -->
        <div class="flex-grow-1" id="mainContent" style="margin-left: {% if user.is_authenticated %}230px{% else %}0{% endif %}; transition: margin-left 0.3s;">
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
                <div class="container-fluid">
                    <a class="navbar-brand" href="{% url 'shift_log:dashboard' %}">
                        <i class="bi bi-journal-text"></i> Сменный журнал
                    </a>
                    <div class="collapse navbar-collapse justify-content-end" id="topbarNav">
                        <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle user-menu" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <div class="user-avatar">
                                <i class="bi bi-person-circle"></i>
                            </div>
                            <span class="user-name">{{ user.get_full_name|default:user.username }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li class="dropdown-header user-info">
                                <div class="user-info-content">
                                    <div class="user-info-name">{{ user.get_full_name|default:user.username }}</div>
                                    <div class="user-info-department">{{ user.employee.department.name }}</div>
                                    <div class="user-info-position">{{ user.employee.get_position_display }}</div>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'shift_log:logout' %}">
                                <i class="bi bi-box-arrow-right"></i> Выйти
                            </a></li>
                        </ul>
                    </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-bell"></i>
                                    <span class="badge bg-danger" id="notification-count">0</span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end" id="notifications-menu">
                                    <li><h6 class="dropdown-header">Уведомления</h6></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'shift_log:notifications_list' %}">Все уведомления</a></li>
                                </ul>
                            </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container-fluid mt-3" style="max-width: 100vw;">
        <!-- CSRF Token -->
        {% csrf_token %}
        
        <!-- Messages -->
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Page Content -->
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="text-muted mb-0">&copy; 2024 Система сменного журнала</p>
                </div>
                <div class="col-md-6 text-end">
                    <p class="text-muted mb-0">Цифровой департамент</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Custom JS -->
    <script src="{% static 'js/main.js' %}"></script>
    
    {% block extra_js %}
    <script>
    // Sidebar toggle: десктоп — sidebar-collapsed, моб — show
    document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.getElementById('sidebarMenu');
        const backdrop = document.getElementById('sidebarBackdrop');
        const toggler = document.getElementById('sidebarToggle');
        const body = document.body;
        const isMobile = () => window.innerWidth < 768;
        if (toggler && sidebar) {
            toggler.addEventListener('click', function() {
                console.log("Sidebar toggle clicked");
                if (isMobile()) {
                    sidebar.classList.toggle('show');
                    backdrop.classList.toggle('d-none');
                    toggler.setAttribute('aria-expanded', sidebar.classList.contains('show'));
                } else {
                    body.classList.toggle('sidebar-collapsed');
                }
            });
        }
        if (backdrop) {
            backdrop.addEventListener('click', function() {
                sidebar.classList.remove('show');
                backdrop.classList.add('d-none');
                if (toggler) toggler.setAttribute('aria-expanded', 'false');
            });
        }
        // Highlight active link
        if (sidebar) {
            var links = sidebar.querySelectorAll('.nav-link');
            links.forEach(function(link) {
                if (link.href === window.location.href) {
                    link.classList.add('active');
                }
            });
        }
    });
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% endblock %}
</body>
</html> 