{% extends 'base.html' %}
{% load static %}

{% block title %}{{ feature.title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Заголовок -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-bug text-primary"></i>
                        {{ feature.title }}
                    </h1>
                    <p class="text-muted mb-0">
                        <i class="bi bi-folder"></i>
                        Проект: <a href="{% url 'testing:testproject_detail' feature.test_project.pk %}">{{ feature.test_project.name }}</a>
                        <span class="mx-2">•</span>
                        <i class="bi bi-person"></i>
                        Создатель: {{ feature.created_by.get_full_name }}
                        <span class="mx-2">•</span>
                        <i class="bi bi-calendar"></i>
                        {{ feature.created_at|date:"d.m.Y H:i" }}
                    </p>
                </div>
                <div>
                    <span class="badge bg-{% cycle 'primary' 'warning' 'success' 'danger' 'info' %} fs-6">
                        {{ feature.get_status_display }}
                    </span>
                    <span class="badge bg-{% cycle 'success' 'info' 'warning' 'danger' %} ms-2">
                        {{ feature.get_priority_display }}
                    </span>
                </div>
            </div>

            <div class="row">
                <!-- Основная информация -->
                <div class="col-lg-8">
                    <!-- Описание -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-info-circle"></i>
                                Описание функционала
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{ feature.description|linebreaks }}</p>
                        </div>
                    </div>

                    <!-- Активные замечания -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-chat-dots"></i>
                                Активные замечания
                            </h5>
                            {% if employee.position == 'admin' or employee.role == 'tester' %}
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addCommentModal">
                                <i class="bi bi-plus-circle"></i>
                                Добавить замечание
                            </button>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if open_comments %}
                            {% for comment in open_comments %}
                            <div class="border-start border-4 border-{% if comment.comment_type == 'remark' %}danger{% elif comment.comment_type == 'approval' %}success{% else %}info{% endif %} ps-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <strong>{{ comment.author.get_full_name }}</strong>
                                        <span class="badge bg-{% if comment.comment_type == 'remark' %}danger{% elif comment.comment_type == 'approval' %}success{% else %}info{% endif %} ms-2">
                                            {{ comment.get_comment_type_display }}
                                        </span>
                                        <span class="badge bg-{% if comment.status == 'open' %}primary{% elif comment.status == 'in_progress' %}info{% elif comment.status == 'rework' %}warning{% endif %} ms-1">
                                            {{ comment.get_status_display }}
                                        </span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <small class="text-muted">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                                        {% if comment.status in 'open,in_progress,rework' and employee.role == 'programmer' and feature.created_by == employee %}
                                        <form method="post" action="{% url 'testing:feature_resolve_comment' feature.pk comment.pk %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-success" 
                                                    onclick="return confirm('Отметить замечание как решенное и запросить повторную проверку?')"
                                                    title="Отметить как решенное">
                                                <i class="bi bi-check-circle"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                                <p class="mb-0">{{ comment.comment|linebreaks }}</p>
                                {% if comment.rework_reason %}
                                <div class="mt-2 p-2 bg-warning bg-opacity-10 border-start border-warning border-3">
                                    <small class="text-muted">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        <strong>Причина возврата на доработку:</strong><br>
                                        {{ comment.rework_reason|linebreaks }}
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="text-center py-3">
                                <i class="bi bi-chat-dots display-4 text-muted"></i>
                                <p class="text-muted mt-2">Нет активных замечаний</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Решенные замечания -->
                    {% if resolved_comments %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-check-circle"></i>
                                Решенные замечания (требуют проверки)
                            </h5>
                        </div>
                        <div class="card-body">
                            {% for comment in resolved_comments %}
                            <div class="border-start border-4 border-success ps-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <strong>{{ comment.author.get_full_name }}</strong>
                                        <span class="badge bg-{% if comment.comment_type == 'remark' %}danger{% elif comment.comment_type == 'approval' %}success{% else %}info{% endif %} ms-2">
                                            {{ comment.get_comment_type_display }}
                                        </span>
                                        <span class="badge bg-success ms-1">Решено</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <small class="text-muted">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                                        {% if employee.role == 'tester' or employee.position == 'admin' %}
                                        <button type="button" class="btn btn-sm btn-outline-success" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#completeModal{{ comment.pk }}"
                                                title="Завершить замечание">
                                            <i class="bi bi-check2-circle"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#returnToReworkModal{{ comment.pk }}"
                                                title="Вернуть на доработку">
                                            <i class="bi bi-arrow-left-circle"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                <p class="mb-0">{{ comment.comment|linebreaks }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Завершенные замечания -->
                    {% if completed_comments %}
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-check2-circle"></i>
                                Завершенные замечания
                            </h5>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleCompletedCommentsBtn" 
                                    data-feature-id="{{ feature.pk }}" 
                                    data-project-id="{{ feature.test_project.pk }}"
                                    title="Скрыть/показать завершенные замечания">
                                <i class="bi bi-eye-slash" id="completedCommentsIcon"></i>
                                <span id="completedCommentsText">Скрыть</span>
                            </button>
                        </div>
                        <div class="card-body" id="completedCommentsContent">
                            {% for comment in completed_comments %}
                            <div class="border-start border-4 border-success ps-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <strong>{{ comment.author.get_full_name }}</strong>
                                        <span class="badge bg-{% if comment.comment_type == 'remark' %}danger{% elif comment.comment_type == 'approval' %}success{% else %}info{% endif %} ms-2">
                                            {{ comment.get_comment_type_display }}
                                        </span>
                                        <span class="badge bg-success ms-1">Завершено</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <small class="text-muted">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                                        {% if comment.completed_at %}
                                        <small class="text-muted">Завершено: {{ comment.completed_at|date:"d.m.Y H:i" }}</small>
                                        {% endif %}
                                        {% if employee.role == 'tester' or employee.position == 'admin' %}
                                        <button type="button" class="btn btn-sm btn-outline-warning" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#returnToReworkModal{{ comment.pk }}"
                                                title="Вернуть на доработку">
                                            <i class="bi bi-arrow-left-circle"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                <p class="mb-0">{{ comment.comment|linebreaks }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- История замечаний -->
                    {% if comment_history %}
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-clock-history"></i>
                                История изменений замечаний
                            </h5>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleHistoryBtn" 
                                    data-feature-id="{{ feature.pk }}" 
                                    data-project-id="{{ feature.test_project.pk }}"
                                    title="Скрыть/показать историю">
                                <i class="bi bi-eye-slash" id="historyIcon"></i>
                                <span id="historyText">Скрыть</span>
                            </button>
                        </div>
                        <div class="card-body" id="historyContent">
                            {% for history in comment_history %}
                            <div class="d-flex align-items-start mb-3">
                                <div class="flex-shrink-0">
                                    <div class="bg-{% if history.action == 'created' %}primary{% elif history.action == 'resolved' %}success{% elif history.action == 'returned_to_rework' %}warning{% else %}info{% endif %} text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                        <i class="bi {% if history.action == 'created' %}bi-plus-circle{% elif history.action == 'resolved' %}bi-check-circle{% elif history.action == 'returned_to_rework' %}bi-arrow-left-circle{% else %}bi-pencil{% endif %}"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="fw-bold">
                                        {{ history.get_action_display }}
                                        {% if history.action == 'returned_to_rework' %}
                                        <span class="badge bg-warning ms-1">Возврат на доработку</span>
                                        {% elif history.action == 'resolved' %}
                                        <span class="badge bg-success ms-1">Решено</span>
                                        {% endif %}
                                    </div>
                                    <div class="text-muted small">
                                        {{ history.changed_by.get_full_name }} • {{ history.changed_at|date:"d.m.Y H:i" }}
                                    </div>
                                    {% if history.reason %}
                                    <div class="text-muted small mt-1">{{ history.reason }}</div>
                                    {% endif %}
                                    <div class="text-muted small mt-1">
                                        <strong>Замечание:</strong> {{ history.comment.comment|truncatechars:100 }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Вложения -->
                    {% if attachments %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-paperclip"></i>
                                Вложения
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for attachment in attachments %}
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex align-items-center p-2 border rounded">
                                        <i class="bi {{ attachment.get_file_icon }} fs-4 text-primary me-3"></i>
                                        <div class="flex-grow-1">
                                            <div class="fw-bold">{{ attachment.filename }}</div>
                                            <small class="text-muted">
                                                {{ attachment.file_size|filesizeformat }} • 
                                                {{ attachment.uploaded_by.get_full_name }} • 
                                                {{ attachment.uploaded_at|date:"d.m.Y H:i" }}
                                            </small>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            {% if attachment.is_viewable_in_browser %}
                                            <a href="#" class="btn btn-outline-primary" title="Просмотр">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            {% endif %}
                                            <a href="#" class="btn btn-outline-secondary" title="Скачать">
                                                <i class="bi bi-download"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Боковая панель -->
                <div class="col-lg-4">
                    <!-- Быстрые действия -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-lightning"></i>
                                Быстрые действия
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if feature.status == 'rework' and employee.role == 'programmer' and feature.created_by == employee %}
                            <button class="btn btn-success w-100 mb-2" onclick="markCompleted()">
                                <i class="bi bi-check-circle"></i>
                                Отметить как выполненный
                            </button>
                            {% endif %}
                            
                            {% if can_edit_feature %}
                            <a href="{% url 'testing:feature_update' feature.pk %}" class="btn btn-outline-secondary w-100 mb-2">
                                <i class="bi bi-pencil"></i>
                                Редактировать
                            </a>
                            {% endif %}
                            
                            <a href="{% url 'testing:feature_list' %}" class="btn btn-outline-primary w-100">
                                <i class="bi bi-arrow-left"></i>
                                Назад к списку
                            </a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления замечания -->
{% if employee.position == 'admin' or employee.role == 'tester' %}
<div class="modal fade" id="addCommentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить замечание</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'testing:feature_add_comment' feature.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        {{ comment_form.comment_type.label_tag }}
                        {{ comment_form.comment_type }}
                    </div>
                    <div class="mb-3">
                        {{ comment_form.comment.label_tag }}
                        {{ comment_form.comment }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить замечание</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
// Добавляем классы Bootstrap к полям формы
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        if (input.classList.contains('is-invalid')) {
            input.classList.add('is-invalid');
        } else {
            input.classList.add('form-control');
        }
    });
    
    // Инициализация состояния истории
    initializeHistoryToggle();
    
    // Инициализация состояния завершенных замечаний
    initializeCompletedCommentsToggle();
});

// Функция для отметки как выполненный
function markCompleted() {
    if (confirm('Отметить функционал как выполненный?')) {
        fetch('{% url "testing:feature_update_status" feature.pk %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'status=completed&comment=Отмечено как выполненный программистом'
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Ошибка при обновлении статуса');
            }
        })
        .catch(error => {
            alert('Ошибка: ' + error);
        });
    }
}

// Функции для управления историей
function initializeHistoryToggle() {
    const toggleBtn = document.getElementById('toggleHistoryBtn');
    const historyContent = document.getElementById('historyContent');
    
    if (!toggleBtn || !historyContent) {
        return; // Элементы не найдены, выходим
    }
    
    const projectId = toggleBtn.getAttribute('data-project-id');
    const featureId = toggleBtn.getAttribute('data-feature-id');
    const storageKey = `feature_history_hidden_project_${projectId}`;
    
    // Проверяем сохраненное состояние
    const isHidden = localStorage.getItem(storageKey) === 'true';
    
    if (isHidden) {
        hideHistory();
    } else {
        showHistory();
    }
    
    // Добавляем обработчик клика
    toggleBtn.addEventListener('click', function() {
        const isCurrentlyHidden = historyContent.classList.contains('hidden') || 
                                 historyContent.style.display === 'none';
        
        // Добавляем анимацию клика
        toggleBtn.classList.add('clicked');
        setTimeout(() => toggleBtn.classList.remove('clicked'), 300);
        
        if (isCurrentlyHidden) {
            showHistory();
        } else {
            hideHistory();
        }
        
        // Сохраняем состояние в localStorage
        localStorage.setItem(storageKey, (!isCurrentlyHidden).toString());
    });
}

function hideHistory() {
    const historyContent = document.getElementById('historyContent');
    const historyIcon = document.getElementById('historyIcon');
    const historyText = document.getElementById('historyText');
    const card = historyContent.closest('.card');
    
    if (historyContent) {
        // Добавляем классы для анимации
        historyContent.classList.remove('visible');
        historyContent.classList.add('hidden');
        
        // Устанавливаем display: none после завершения анимации
        setTimeout(() => {
            historyContent.style.display = 'none';
        }, 300);
    }
    
    if (historyIcon) {
        historyIcon.className = 'bi bi-eye';
    }
    
    if (historyText) {
        historyText.textContent = 'Показать';
    }
    
    if (card) {
        card.classList.remove('history-visible');
        card.classList.add('history-hidden');
    }
}

function showHistory() {
    const historyContent = document.getElementById('historyContent');
    const historyIcon = document.getElementById('historyIcon');
    const historyText = document.getElementById('historyText');
    const card = historyContent.closest('.card');
    
    if (historyContent) {
        // Сначала показываем элемент
        historyContent.style.display = 'block';
        
        // Затем запускаем анимацию
        setTimeout(() => {
            historyContent.classList.remove('hidden');
            historyContent.classList.add('visible');
        }, 10);
    }
    
    if (historyIcon) {
        historyIcon.className = 'bi bi-eye-slash';
    }
    
    if (historyText) {
        historyText.textContent = 'Скрыть';
    }
    
    if (card) {
        card.classList.remove('history-hidden');
        card.classList.add('history-visible');
    }
}

// Функции для управления завершенными замечаниями
function initializeCompletedCommentsToggle() {
    const toggleBtn = document.getElementById('toggleCompletedCommentsBtn');
    const completedCommentsContent = document.getElementById('completedCommentsContent');
    
    if (!toggleBtn || !completedCommentsContent) {
        return; // Элементы не найдены, выходим
    }
    
    const projectId = toggleBtn.getAttribute('data-project-id');
    const featureId = toggleBtn.getAttribute('data-feature-id');
    const storageKey = `feature_completed_comments_hidden_project_${projectId}_feature_${featureId}`;
    
    // Проверяем сохраненное состояние
    const isHidden = localStorage.getItem(storageKey) === 'true';
    
    if (isHidden) {
        hideCompletedComments();
    } else {
        showCompletedComments();
    }
    
    // Добавляем обработчик клика
    toggleBtn.addEventListener('click', function() {
        const isCurrentlyHidden = completedCommentsContent.classList.contains('hidden') || 
                                 completedCommentsContent.style.display === 'none';
        
        // Добавляем анимацию клика
        toggleBtn.classList.add('clicked');
        setTimeout(() => toggleBtn.classList.remove('clicked'), 300);
        
        if (isCurrentlyHidden) {
            showCompletedComments();
        } else {
            hideCompletedComments();
        }
        
        // Сохраняем состояние в localStorage
        localStorage.setItem(storageKey, (!isCurrentlyHidden).toString());
    });
}

function hideCompletedComments() {
    const completedCommentsContent = document.getElementById('completedCommentsContent');
    const completedCommentsIcon = document.getElementById('completedCommentsIcon');
    const completedCommentsText = document.getElementById('completedCommentsText');
    const card = completedCommentsContent.closest('.card');
    
    if (completedCommentsContent) {
        // Добавляем классы для анимации
        completedCommentsContent.classList.remove('visible');
        completedCommentsContent.classList.add('hidden');
        
        // Устанавливаем display: none после завершения анимации
        setTimeout(() => {
            completedCommentsContent.style.display = 'none';
        }, 300);
    }
    
    if (completedCommentsIcon) {
        completedCommentsIcon.className = 'bi bi-eye';
    }
    
    if (completedCommentsText) {
        completedCommentsText.textContent = 'Показать';
    }
    
    if (card) {
        card.classList.remove('completed-comments-visible');
        card.classList.add('completed-comments-hidden');
    }
}

function showCompletedComments() {
    const completedCommentsContent = document.getElementById('completedCommentsContent');
    const completedCommentsIcon = document.getElementById('completedCommentsIcon');
    const completedCommentsText = document.getElementById('completedCommentsText');
    const card = completedCommentsContent.closest('.card');
    
    if (completedCommentsContent) {
        // Сначала показываем элемент
        completedCommentsContent.style.display = 'block';
        
        // Затем запускаем анимацию
        setTimeout(() => {
            completedCommentsContent.classList.remove('hidden');
            completedCommentsContent.classList.add('visible');
        }, 10);
    }
    
    if (completedCommentsIcon) {
        completedCommentsIcon.className = 'bi bi-eye-slash';
    }
    
    if (completedCommentsText) {
        completedCommentsText.textContent = 'Скрыть';
    }
    
    if (card) {
        card.classList.remove('completed-comments-hidden');
        card.classList.add('completed-comments-visible');
    }
}
</script>

<!-- Модальные окна для завершения замечаний -->
{% for comment in resolved_comments %}
    {% if employee.role == 'tester' or employee.position == 'admin' %}
<div class="modal fade" id="completeModal{{ comment.pk }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Завершить замечание</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'testing:feature_comment_complete' feature.pk comment.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Замечание:</label>
                        <div class="p-2 bg-light rounded">{{ comment.comment|linebreaks }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="comment{{ comment.pk }}" class="form-label">Комментарий к завершению</label>
                        <textarea class="form-control" id="comment{{ comment.pk }}" name="comment" rows="3" 
                                  placeholder="Дополнительный комментарий к завершению замечания (необязательно)"></textarea>
                        <div class="form-text">Дополнительный комментарий к завершению замечания</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">Завершить замечание</button>
                </div>
            </form>
        </div>
    </div>
</div>
    {% endif %}
{% endfor %}

<!-- Модальные окна для возврата замечаний на доработку -->
{% for comment in resolved_comments %}
    {% if employee.role == 'tester' or employee.position == 'admin' %}
<div class="modal fade" id="returnToReworkModal{{ comment.pk }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Возврат замечания на доработку</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'testing:feature_comment_return_to_rework' feature.pk comment.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Замечание:</label>
                        <div class="p-2 bg-light rounded">{{ comment.comment|linebreaks }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="reason{{ comment.pk }}" class="form-label">Причина возврата на доработку *</label>
                        <textarea class="form-control" id="reason{{ comment.pk }}" name="reason" rows="3" 
                                  placeholder="Укажите причину возврата замечания на доработку" required></textarea>
                        <div class="form-text">Обязательно укажите причину возврата замечания на доработку</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-warning">Вернуть на доработку</button>
                </div>
            </form>
        </div>
    </div>
</div>
    {% endif %}
{% endfor %}

{% for comment in completed_comments %}
    {% if employee.role == 'tester' or employee.position == 'admin' %}
<div class="modal fade" id="returnToReworkModal{{ comment.pk }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Возврат замечания на доработку</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'testing:feature_comment_return_to_rework' feature.pk comment.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Замечание:</label>
                        <div class="p-2 bg-light rounded">{{ comment.comment|linebreaks }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="reason{{ comment.pk }}" class="form-label">Причина возврата на доработку *</label>
                        <textarea class="form-control" id="reason{{ comment.pk }}" name="reason" rows="3" 
                                  placeholder="Укажите причину возврата замечания на доработку" required></textarea>
                        <div class="form-text">Обязательно укажите причину возврата замечания на доработку</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-warning">Вернуть на доработку</button>
                </div>
            </form>
        </div>
    </div>
</div>
    {% endif %}
{% endfor %}
{% endblock %}
